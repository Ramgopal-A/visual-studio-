<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Entry Log System</title>
  </head>
  <body>
    <div class="container">
      <div class="name-phone-container">
        <label for="name">NAME:</label>
        <input type="text" id="name" placeholder="Enter your name" />
        <label for="phone">PHONE NUMBER:</label>
        <input type="text" id="phone" placeholder="Enter your phone number" />
        <label for="floor">Floor name:</label>
        <select id="floor">
          <option value="1st Floor">1st Floor</option>
          <option value="2nd Floor">2nd Floor</option>
        </select>
      </div>
      <br />
      <div class="form-row">
        <label for="gender">gender:</label>
        <select id="gender">
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="Trans">Trans</option>
        </select>
        <label for="room">Room no:</label>
        <select id="room">
          <option value="101">101</option>
          <option value="102">102</option>
        </select>
        <label for="reason">Reason:</label>
        <select id="reason">
          <option value="Meeting">Meeting</option>
          <option value="Inspection">Inspection</option>
        </select>
        <button class="entry-button" onclick="addEntry()">Entry</button>
        <button class="admin-button">Admin</button>
      </div>
    </div>
    <div class="log-container">
      <h2><i>ENTRY LOGS</i></h2>
      <h3 id="today-date"><i>DD/MM/YYYY</i></h3>
      <table class="log-table" id="log-table">
        <tr>
          <th>Name</th>
          <th>Floor name</th>
          <th>Room no</th>
          <th>Reason</th>
          <th>Time of Entry</th>
          <th>Time of Exit</th>
          <th>Actions</th>
        </tr>
      </table>
    </div>
  </body>
  <script>
    async function addEntry() {
      var name = document.getElementById("name").value;
      var phone = document.getElementById("phone").value;
      var floor = document.getElementById("floor").value;
      var gender = document.getElementById("gender").value;
      var room = document.getElementById("room").value;
      var reason = document.getElementById("reason").value;
      var timeOfEntry = new Date().toLocaleTimeString();

      if (!name || !phone) {
        alert("Please enter both name and phone number.");
        return;
      }

      var table = document.getElementById("log-table");
      var row = table.insertRow(-1);
      row.insertCell(0).textContent = name;
      row.insertCell(1).textContent = floor;
      row.insertCell(2).textContent = room;
      row.insertCell(3).textContent = reason;
      row.insertCell(4).textContent = timeOfEntry;
      var exitTimeCell = row.insertCell(5);
      var exitCell = row.insertCell(6);
      
      var exitButton = document.createElement("button");
      exitButton.textContent = "Exit";
      exitButton.className = "exit-button";
      exitButton.onclick = async function () {
        var timeOfExit = new Date().toLocaleTimeString();
        exitTimeCell.textContent = timeOfExit;
        
        let model = {
          PhoneNumber: phone,
          ExitTime: timeOfExit,
        };

        try {
          let response = await fetch("http://localhost:5000/api/user/UpdateExitTime", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(model),
          });

          if (!response.ok) {
            let errorText = await response.text();
            throw new Error("Server Error: " + errorText);
          }

          let result = await response.json();
          console.log("Server Response:", result);
        } catch (error) {
          console.error("Error:", error);
          alert("Failed to update exit time on the server.");
        }
      };
      exitCell.appendChild(exitButton);
      
      let data = {
        FullName: name,
        PhoneNumber: phone,
        Floor: floor,
        Gender: gender,
        Room: room,
        Reason: reason,
        EntryTime: timeOfEntry,
      };

      try {
        let response = await fetch("http://localhost:5000/api/user/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          let errorText = await response.text();
          throw new Error("Server Error: " + errorText);
        }

        let result = await response.json();
        console.log("Server Response:", result);
      } catch (error) {
        console.error("Error:", error);
        alert("Failed to save entry to the server.");
      }
    }
  </script>
</html>
