<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Entry Log System</title>
  </head>
  <body>
    <div class="container">
      <div class="name-phone-container">
        <label for="name">NAME:</label>
        <input type="text" id="name" placeholder="Enter your name" />
        <label for="phone">PHONE NUMBER:</label>
        <input type="text" id="phone" placeholder="Enter your phone number" />
        <label for="floor">Floor name:</label>
        <select id="floor">
          <option value="1st Floor">1st Floor</option>
          <option value="2nd Floor">2nd Floor</option>
        </select>
      </div>
      <br />
      <div class="form-row">
        <label for="gender">Gender:</label>
        <select id="gender">
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="Trans">Trans</option>
        </select>
        <label for="room">Room no:</label>
        <select id="room">
          <option value="101">101</option>
          <option value="102">102</option>
        </select>
        <label for="reason">Reason:</label>
        <select id="reason">
          <option value="Meeting">Meeting</option>
          <option value="Inspection">Inspection</option>
        </select>
        <button class="entry-button" onclick="addEntry()">Entry</button>
        <button class="admin-button">Admin</button>
      </div>
    </div>

    <div class="log-container">
      <h2><i>ENTRY LOGS</i></h2>
      <h3 id="today-date"><i>DD/MM/YYYY</i></h3>
      <table class="log-table" id="log-table">
        <tr>
          <th>Name</th>
          <th>Floor</th>
          <th>Room</th>
          <th>Reason</th>
          <th>Time of Entry</th>
          <th>Time of Exit</th>
          <th>Actions</th>
        </tr>
      </table>
    </div>

    <h3>Pending Visits</h3>
    <ul id="pending-visits-list"></ul>
    <button onclick="fetchPendingVisits()">Load Pending Visits</button>

    <script>
      async function addEntry() {
        var name = document.getElementById("name").value;
        var phone = document.getElementById("phone").value;
        var floor = document.getElementById("floor").value;
        var gender = document.getElementById("gender").value;
        var room = document.getElementById("room").value;
        var reason = document.getElementById("reason").value;
        var timeOfEntry = new Date().toLocaleTimeString();

        if (!name || !phone) {
          alert("Please enter both name and phone number.");
          return;
        }

        let data = {
          FullName: name,
          PhoneNumber: phone,
          Floor: floor,
          Gender: gender,
          Room: room,
          Reason: reason,
          EntryTime: timeOfEntry,
        };

        try {
          let response = await fetch("http://localhost:5000/api/user/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          let result = await response.json();
          console.log("Server Response:", result);
          fetchPendingVisits(); // Refresh pending visits after adding entry
        } catch (error) {
          console.error("Error:", error);
          alert("Failed to save entry to the server.");
        }
      }

      async function updateExitTime(visitId) {
        let timeOfExit = new Date().toLocaleTimeString();

        let model = {
          VisitId: visitId, // Use visit _id instead of phone number
          ExitTime: timeOfExit,
        };

        
        try {
          let response = await fetch(
            "http://localhost:5000/api/user/updateExitTime",
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(model),
            }
          );

          let result = await response.json();
          alert(result.message);
          fetchPendingVisits(); // Refresh list after updating exit time
        } catch (error) {
          console.error("Error updating exit time:", error);
        }
      }

      async function fetchPendingVisits() {
        let userName = document.getElementById("name").value.trim();

        if (!userName) {
          alert("Please enter your name before checking pending visits.");
          return;
        }
        try {
          let response = await fetch(`http://localhost:5000/api/user/getPending?fullName=${encodeURIComponent(userName)}`);
          let users = await response.json();

          let list = document.getElementById("pending-visits-list");
          list.innerHTML = ""; // Clear the list before adding new items

          if (users.length === 0) {
            let li = document.createElement("li");
            li.textContent = "No pending visits found for this user.";
            list.appendChild(li);
            return;
        }

          users.forEach((user) => {
            if (!user.exitTime || user.exitTime === "") {
              let li = document.createElement("li");
              li.textContent = `Name: ${user.fullName}, Entry Time: ${user.entryTime}`;

              let updateButton = document.createElement("button");
              updateButton.textContent = "Set Exit Time";
              updateButton.onclick = () => updateExitTime(user.id); // Send visit ID

              li.appendChild(updateButton);
              list.appendChild(li);
            }
          });
        } catch (error) {
          console.error("Error fetching pending visits:", error);
        }
      }
    </script>
  </body>
</html>
